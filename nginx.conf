server {
    listen 80;
    server_name _;  # 또는 your-domain.com

    # 클라이언트 최대 업로드 크기
    client_max_body_size 10M;

    # Gzip 압축
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # API proxied to backend running on port 5000
    # NOTE: proxy_pass에 끝 슬래시가 있으면 location 매칭 부분이 치환되어 '/api'가 제거될 수 있습니다.
    #       백엔드 라우트가 '/api/...'로 마운트되어 있으므로 슬래시를 제거해 원본 URI가 유지되도록 합니다.
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend served by Next.js (PM2) on port 3000
    # root 경로를 프록시할 때도 동일하게 슬래시 없는 proxy_pass를 사용해 경로 보존을 명확히 합니다.
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 정적 파일 캐싱
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
